<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Altƒ±n & D√∂viz Hesaplama</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    background:#f4f4f4;
    max-width:900px;
    margin:auto;
    padding:15px;
}
h2 { text-align:center; }

table {
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th, td {
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
}
th { background:#eaeaea; }

input, select {
    width:80px;
    padding:5px;
}

.butonlar {
    display:flex;
    gap:10px;
    margin-top:15px;
}
button {
    flex:1;
    padding:10px;
    font-size:16px;
}

.toplam {
    margin-top:20px;
    font-size:24px;
    text-align:right;
    font-weight:bold;
}

@media (max-width:600px) {
    input, select { width:65px; }
}

/* DARK MODE */
body.dark {
    background:#121212;
    color:#eaeaea;
}
body.dark th { background:#1f1f1f; }
body.dark td { border-color:#333; }
body.dark input, body.dark select {
    background:#1e1e1e;
    color:#fff;
    border:1px solid #444;
}
body.dark button { background:#333; color:#fff; }
</style>
</head>

<body>

<h2>Altƒ±n & D√∂viz Hesaplama</h2>
<button id="temaBtn" onclick="temaDegistir()">üåô Koyu Mod</button>

<table>
<thead>
<tr>
<th>T√ºr</th>
<th>Fiyat T√ºr√º</th>
<th>Gram / Adet</th>
<th>Tutar (TL)</th>
</tr>
</thead>
<tbody id="tablo"></tbody>
</table>

<div class="butonlar">
<button onclick="hesapla()">HESAPLA</button>
<button onclick="temizle()">TEMƒ∞ZLE</button>
</div>

<div class="toplam" id="toplam">Toplam: ‚Äî</div>

<script>
const API_KEY = "apikey 5xpyQEvnvvTLPUM69V7uui:11cUxwSdipU6iVr9Wk8mVy";

/* üîß MAKAS KIRPMA ORANI (%50) */
const MAKAS_KIRPMA_ORANI = 0.5;

const varliklar = [
    { ad:"24 Ayar Gram Altƒ±n", api:"Gram Altƒ±n" },
    { ad:"22 Ayar Gram Altƒ±n", api:"Gram Altƒ±n", katsayi:0.916 },
    { ad:"√áeyrek Altƒ±n", api:"√áeyrek Altƒ±n" },
    { ad:"Yarƒ±m Altƒ±n", api:"Yarƒ±m Altƒ±n" },
    { ad:"Tam Altƒ±n", api:"Tam Altƒ±n" },
    { ad:"Cumhuriyet Altƒ±nƒ±", api:"Cumhuriyet Altƒ±nƒ±" },
    { ad:"Re≈üat Altƒ±n", api:"Re≈üat Altƒ±n" },
    { ad:"Ata Altƒ±n", api:"Ata Altƒ±n" },
    { ad:"USD", api:"USD" },
    { ad:"EUR", api:"EUR" },
    { ad:"Bank", manuel:true }
];

let fiyatlar = {};

/* ‚úÖ KUYUMCU ORTALAMASI */
function ortalamaFiyat(buy, sell) {
    if (!buy || !sell) return 0;
    const makas = sell - buy;
    return sell - (makas * MAKAS_KIRPMA_ORANI);
}

async function baslat() {

    /* ALTIN */
    const altinRes = await fetch(
        "https://api.collectapi.com/economy/goldPrice",
        { headers:{ authorization:"apikey "+API_KEY } }
    );
    const altinData = await altinRes.json();

    altinData.result.forEach(i=>{
        fiyatlar[i.name] = {
            buying: Number(i.buying),
            selling: Number(i.selling)
        };
    });

    if (!fiyatlar["Re≈üat Altƒ±n"] && fiyatlar["Cumhuriyet Altƒ±nƒ±"]) {
        fiyatlar["Re≈üat Altƒ±n"] = fiyatlar["Cumhuriyet Altƒ±nƒ±"];
    }

    /* D√ñVƒ∞Z */
    const dovizRes = await fetch(
        "https://api.collectapi.com/economy/allCurrency",
        { headers:{ authorization:"apikey "+API_KEY } }
    );
    const dovizData = await dovizRes.json();

    dovizData.result.forEach(i=>{
        if(i.code === "USD" || i.code === "EUR"){
            fiyatlar[i.code] = {
                buying: Number(i.buying || i.rate),
                selling: Number(i.selling || i.rate)
            };
        }
    });

    tabloKur();
    yukle();
}

function tabloKur() {
    const t = document.getElementById("tablo");
    t.innerHTML = "";
    varliklar.forEach((v,i)=>{
        t.innerHTML += `
        <tr>
            <td>${v.ad}</td>
            <td>
                ${v.manuel ? "-" : `
                <select id="t${i}">
                    <option value="ortalama" selected>Ortalama</option>
                    <option value="selling">Satƒ±≈ü</option>
                    <option value="buying">Alƒ±≈ü</option>
                </select>`}
            </td>
            <td><input type="number" step="0.01" id="m${i}"></td>
            <td id="s${i}">‚Äî</td>
        </tr>`;
    });
}

function hesapla() {
    let toplam = 0;

    varliklar.forEach((v,i)=>{
        const miktar = Number(document.getElementById("m"+i).value);
        if (!miktar) return;

        if (v.manuel) {
            document.getElementById("s"+i).innerText = miktar.toFixed(2)+" TL";
            toplam += miktar;
            localStorage.setItem("m"+i, miktar);
            return;
        }

        const secim = document.getElementById("t"+i).value;
        const f = fiyatlar[v.api];
        if (!f) return;

        let fiyat =
            secim === "ortalama"
            ? ortalamaFiyat(f.buying, f.selling)
            : f[secim];

        if (v.katsayi) fiyat *= v.katsayi;

        const tutar = miktar * fiyat;
        document.getElementById("s"+i).innerText = tutar.toFixed(2)+" TL";
        toplam += tutar;
        localStorage.setItem("m"+i, miktar);
    });

    document.getElementById("toplam").innerText =
        "Toplam: " + toplam.toFixed(2) + " TL";
}

function yukle() {
    varliklar.forEach((v,i)=>{
        const val = localStorage.getItem("m"+i);
        if(val) document.getElementById("m"+i).value = val;
    });
}

function temizle() {
    varliklar.forEach((v,i)=>{
        document.getElementById("m"+i).value = "";
        document.getElementById("s"+i).innerText = "‚Äî";
        localStorage.removeItem("m"+i);
    });
    document.getElementById("toplam").innerText = "Toplam: ‚Äî";
}

function temaDegistir() {
    document.body.classList.toggle("dark");
    const koyuMu = document.body.classList.contains("dark");
    localStorage.setItem("tema", koyuMu ? "dark" : "light");
    document.getElementById("temaBtn").innerText =
        koyuMu ? "‚òÄÔ∏è A√ßƒ±k Mod" : "üåô Koyu Mod";
}

if (localStorage.getItem("tema") === "dark") {
    document.body.classList.add("dark");
    window.onload = () => temaBtn.innerText = "‚òÄÔ∏è A√ßƒ±k Mod";
}

baslat();
</script>

</body>
</html>
